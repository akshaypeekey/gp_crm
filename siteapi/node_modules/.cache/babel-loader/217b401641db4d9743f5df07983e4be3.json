{"ast":null,"code":"import _regeneratorRuntime from\"W:/new/DRF/siteapi/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"W:/new/DRF/siteapi/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import axios from'axios';var baseURL='https://simplecrm.pythonanywhere.com/api/';var axiosInstance=axios.create({baseURL:baseURL,timeout:5000,headers:{Authorization:'Bearer '+localStorage.getItem('access_token'),'Content-Type':'application/json',accept:'application/json'}});axiosInstance.interceptors.response.use(function(response){return response;},/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(error){var originalRequest,refreshToken,tokenParts,now;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:originalRequest=error.config;if(!(typeof error.response==='undefined')){_context.next=4;break;}alert('A server/network error occurred. '+'Looks like CORS might be the problem. '+'Sorry about this - we will get it fixed shortly.');return _context.abrupt(\"return\",Promise.reject(error));case 4:if(!(error.response.status===401&&originalRequest.url===baseURL+'token/refresh/')){_context.next=7;break;}window.location.href='/login/';return _context.abrupt(\"return\",Promise.reject(error));case 7:if(!(error.response.data.code==='token_not_valid'&&error.response.status===401&&error.response.statusText==='Unauthorized')){_context.next=23;break;}refreshToken=localStorage.getItem('refresh_token');if(!refreshToken){_context.next=21;break;}tokenParts=JSON.parse(atob(refreshToken.split('.')[1]));// exp date in token is expressed in seconds, while now() returns milliseconds:\nnow=Math.ceil(Date.now()/1000);console.log(tokenParts.exp);if(!(tokenParts.exp>now)){_context.next=17;break;}return _context.abrupt(\"return\",axiosInstance.post('/token/refresh/',{refresh:refreshToken}).then(function(response){localStorage.setItem('access_token',response.data.access);localStorage.setItem('refresh_token',response.data.refresh);axiosInstance.defaults.headers['Authorization']='JWT '+response.data.access;originalRequest.headers['Authorization']='JWT '+response.data.access;return axiosInstance(originalRequest);}).catch(function(err){console.log(err);}));case 17:console.log('Refresh token is expired',tokenParts.exp,now);window.location.href='/login/';case 19:_context.next=23;break;case 21:console.log('Refresh token not available.');window.location.href='/login/';case 23:return _context.abrupt(\"return\",Promise.reject(error));case 24:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());export default axiosInstance;","map":{"version":3,"sources":["W:/new/DRF/siteapi/src/axios.js"],"names":["axios","baseURL","axiosInstance","create","timeout","headers","Authorization","localStorage","getItem","accept","interceptors","response","use","error","originalRequest","config","alert","Promise","reject","status","url","window","location","href","data","code","statusText","refreshToken","tokenParts","JSON","parse","atob","split","now","Math","ceil","Date","console","log","exp","post","refresh","then","setItem","access","defaults","catch","err"],"mappings":"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","sourcesContent":["import axios from 'axios';\r\n\r\nconst baseURL = 'https://simplecrm.pythonanywhere.com/api/';\r\n\r\nconst axiosInstance = axios.create({\r\n\tbaseURL: baseURL,\r\n\ttimeout: 5000,\r\n\theaders: {\r\n\t\tAuthorization: 'Bearer ' + localStorage.getItem('access_token'),\r\n\t\t'Content-Type': 'application/json',\r\n\t\taccept: 'application/json',\r\n\t},\r\n});\r\n\r\naxiosInstance.interceptors.response.use(\r\n\t(response) => {\r\n\t\treturn response;\r\n\t},\r\n\tasync function (error) {\r\n\t\tconst originalRequest = error.config;\r\n\r\n\t\tif (typeof error.response === 'undefined') {\r\n\t\t\talert(\r\n\t\t\t\t'A server/network error occurred. ' +\r\n\t\t\t\t\t'Looks like CORS might be the problem. ' +\r\n\t\t\t\t\t'Sorry about this - we will get it fixed shortly.'\r\n\t\t\t);\r\n\t\t\treturn Promise.reject(error);\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\terror.response.status === 401 &&\r\n\t\t\toriginalRequest.url === baseURL + 'token/refresh/'\r\n\t\t) {\r\n\t\t\twindow.location.href = '/login/';\r\n\t\t\treturn Promise.reject(error);\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\terror.response.data.code === 'token_not_valid' &&\r\n\t\t\terror.response.status === 401 &&\r\n\t\t\terror.response.statusText === 'Unauthorized'\r\n\t\t) {\r\n\t\t\tconst refreshToken = localStorage.getItem('refresh_token');\r\n\r\n\t\t\tif (refreshToken) {\r\n\t\t\t\tconst tokenParts = JSON.parse(atob(refreshToken.split('.')[1]));\r\n\r\n\t\t\t\t// exp date in token is expressed in seconds, while now() returns milliseconds:\r\n\t\t\t\tconst now = Math.ceil(Date.now() / 1000);\r\n\t\t\t\tconsole.log(tokenParts.exp);\r\n\r\n\t\t\t\tif (tokenParts.exp > now) {\r\n\t\t\t\t\treturn axiosInstance\r\n\t\t\t\t\t\t.post('/token/refresh/', {\r\n\t\t\t\t\t\t\trefresh: refreshToken,\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\t.then((response) => {\r\n\t\t\t\t\t\t\tlocalStorage.setItem('access_token', response.data.access);\r\n\t\t\t\t\t\t\tlocalStorage.setItem('refresh_token', response.data.refresh);\r\n\r\n\t\t\t\t\t\t\taxiosInstance.defaults.headers['Authorization'] =\r\n\t\t\t\t\t\t\t\t'JWT ' + response.data.access;\r\n\t\t\t\t\t\t\toriginalRequest.headers['Authorization'] =\r\n\t\t\t\t\t\t\t\t'JWT ' + response.data.access;\r\n\r\n\t\t\t\t\t\t\treturn axiosInstance(originalRequest);\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\t.catch((err) => {\r\n\t\t\t\t\t\t\tconsole.log(err);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.log('Refresh token is expired', tokenParts.exp, now);\r\n\t\t\t\t\twindow.location.href = '/login/';\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tconsole.log('Refresh token not available.');\r\n\t\t\t\twindow.location.href = '/login/';\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// specific error handling done elsewhere\r\n\t\treturn Promise.reject(error);\r\n\t}\r\n);\r\n\r\nexport default axiosInstance;"]},"metadata":{},"sourceType":"module"}